app-id: io.github.RodZill4.Material-Maker
runtime: org.freedesktop.Platform
runtime-version: "25.08"
sdk: org.freedesktop.Sdk
command: material-maker
rename-icon: icon
rename-appdata-file: io.github.RodZill4.Material-Maker.appdata.xml

build-options:
  arch:
    x86_64:
      env:
        # Only enable link-time optimization when targeting x86_64
        # (causes issues on other architectures)
        SCONS_FLAGS_EXTRA: use_lto=yes

  env:
        # Will be appended to the version string displayed in the command-line help
        BUILD_NAME: custom_build

        # SCons flags common to all builds
        # Shouldn't be quoted when used as it's a single string, not an array
        SCONS_FLAGS: >
          platform=linuxbsd
          CCFLAGS=-I/app/include
          prefix=/app
          unix_global_settings_path=/app
          progress=no
          builtin_freetype=no
          builtin_libogg=no
          builtin_libpng=no
          builtin_libtheora=no
          builtin_libvorbis=no
          builtin_libwebp=no
          builtin_libvpx=no
          builtin_zlib=no
          udev=no

finish-args:
  - --share=ipc
  - --socket=x11
  - --filesystem=home
  - --device=dri
  - --share=network

modules:

  - name: scons
    buildsystem: simple
    cleanup: ['*']

    sources:
      - type: archive
        sha256: 61e2fc42e0e2c750105d61f26cc1dfebcae9f4103d3dc0e9aeb373016b0d208c
        url: https://downloads.sourceforge.net/project/scons/scons/4.10.0/SCons-4.10.0.tar.gz

    build-commands:
      - pip3 install --no-index --no-build-isolation --prefix=/app .

  - name: material-maker-pack
    buildsystem: simple

    sources:
      - type: archive
        sha256: d6e382fb531019f85630c1f485a561a0d20c4a2344b6c3847735cfee7da812aa
        url: https://github.com/godotengine/godot/releases/download/4.4.1-stable/Godot_v4.4.1-stable_linux.x86_64.zip

      - type: archive
        sha256: a7fa079d509116df077280f838c39a941665abd3f7fe9a3e0e0f0899ff15a286
        url: https://github.com/RodZill4/material-maker/archive/refs/tags/1.4.tar.gz
        dest: material-maker

      - type: patch
        path: mm-fix-filedialog.patch
        options:
          - -d
          - material-maker

    build-commands:
    - ./Godot_v4.4.1-stable_linux.x86_64 --headless -v --path material-maker --export-pack "Linux/X11" material-maker.pck
    - install -Dm644 material-maker/material-maker.pck /app/bin/material-maker.pck

  - name: godot-runner
    buildsystem: simple

    sources:
      - type: archive
        sha256: ddbd6527cdb3ddb02910b383301a5c9117b1c33c777ef1c86d1b1eea43dcb651
        url: https://github.com/godotengine/godot/releases/download/4.4.1-stable/godot-4.4.1-stable.tar.xz

      - type: patch
        path: godot-enable-tinyexr.patch

    build-commands:
      - python3 /app/bin/scons $SCONS_FLAGS $SCONS_FLAGS_EXTRA tools=no target=template_release -j "$FLATPAK_BUILDER_N_JOBS"
      - install -Dm755 bin/godot.linuxbsd.* /app/bin/godot-runner

  - name: material-maker
    buildsystem: simple

    sources:
      - type: archive
        url: https://github.com/RodZill4/material-maker/releases/download/1.4/material_maker_1_4_linux.tar.gz
        sha256: b6ef34891a60ed898c6b6f977f107889e952280898405128eabaa50501a82531

      - type: script
        dest-filename: material_maker.sh
        commands:
          # `cd` is needed so that Material Maker can find its data directories.
          - cd /app/bin/
          # Use the `Dummy` audio driver to avoid error messages when starting the application from a terminal.
          - /app/bin/godot-runner --audio-driver Dummy --main-pack /app/bin/material-maker.pck "$@"

      - type: file
        url: https://github.com/RodZill4/material-maker/raw/1.4/icon.png
        sha256: 72ee1a0fc59b798b8849eb9bd0cb7b67fd9ee3ff41645f90c2ca98168f3619ef

      - type: file
        url: https://github.com/RodZill4/material-maker/raw/1.4/material_maker/misc/linux/io.github.RodZill4.Material-Maker.desktop
        sha256: 381e6425233d0aa3786c5583a2415d0d20b828481fa93dceac1e4376481d1330

      - type: file
        path: io.github.RodZill4.Material-Maker.appdata.xml

    build-commands:
      - install -Dm755 material_maker.sh /app/bin/material-maker
      - mv {examples,library,nodes,doc,environments,meshes,export}/ /app/bin/
      - install -Dm644 icon.png -t /app/share/icons/hicolor/256x256/apps/
      - install -Dm644 io.github.RodZill4.Material-Maker.desktop -t /app/share/applications/
      - install -Dm644 io.github.RodZill4.Material-Maker.appdata.xml -t /app/share/appdata/
